describe('Client Collection Flow - Complete Integration Test', () => {
  let createdAddressId: string;
  let tomorrowDate: string;

  before(() => {
    // Calcular data D+1 uma vez para todos os testes
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrowDate = tomorrow.toISOString().split('T')[0];
  });

  beforeEach(() => {
    // Interceptar chamadas de API para melhor controle
    cy.intercept('POST', '/api/client/create-address').as('createAddress');
    cy.intercept('POST', '/api/client/set-vehicles-collection').as('setVehiclesCollection');
    cy.intercept('POST', '/api/client/collection-reschedule').as('rescheduleCollection');
  });

  it('should complete full client collection flow: login ‚Üí add collection point ‚Üí assign vehicles ‚Üí D+1 date', () => {
    // ========================================================================================
    // SETUP: LOGIN E NAVEGA√á√ÉO
    // ========================================================================================
    cy.log('üöÄ INICIANDO FLUXO COMPLETO DE COLETA DO CLIENTE');

    // 1. Login usando comando personalizado
    cy.login('cliente@prolineauto.com.br', '123qwe');

    // 2. Verificar se estamos no dashboard correto
    cy.url().should('include', '/dashboard');
    cy.contains('Bem-vindo').should('be.visible');
    cy.contains('Painel do Cliente').should('be.visible');

    cy.log('‚úÖ Login realizado com sucesso');

    // ========================================================================================
    // PASSO 1: ADICIONAR PONTO DE COLETA
    // ========================================================================================
    cy.log('üìç PASSO 1: Adicionando novo ponto de coleta');

    // 1.1 Clicar no bot√£o "Adicionar Ponto de Coleta"
    cy.contains('Adicionar Ponto de Coleta').click();

    // 1.2 Verificar se modal abriu
    cy.get('[data-cy="address-modal"], .modal').should('be.visible');
    cy.contains('Adicionar Ponto de Coleta').should('be.visible');

    // 1.3 Preencher formul√°rio com dados v√°lidos
    cy.get('#zip_code').type('01310-100');
    cy.wait(2000); // Aguardar preenchimento autom√°tico

    // Completar campos restantes
    cy.get('#street').clear().type('Avenida Paulista');
    cy.get('#number').clear().type('1578');
    cy.get('#neighborhood').clear().type('Bela Vista');
    cy.get('#city').clear().type('S√£o Paulo');
    cy.get('#state').clear().type('SP');
    cy.get('#complement').clear().type('Pr√≥ximo ao MASP');

    // 1.4 Submeter formul√°rio
    cy.get('button[type="submit"]').contains('Cadastrar Endere√ßo').click();

    // 1.5 Aguardar resposta da API e verificar sucesso
    cy.wait('@createAddress').then(interception => {
      expect(interception.response?.statusCode).to.eq(200);
      expect(interception.response?.body.success).to.be.true;
    });

    // 1.6 Verificar modal de sucesso
    cy.contains('Sucesso').should('be.visible');
    cy.contains('Endere√ßo cadastrado com sucesso').should('be.visible');

    // 1.7 Fechar modal
    cy.get('[data-cy="close-modal"], .modal button').contains('OK').click();

    cy.log('‚úÖ Ponto de coleta adicionado com sucesso');

    // ========================================================================================
    // PASSO 2: VERIFICAR VE√çCULOS DISPON√çVEIS
    // ========================================================================================
    cy.log('üöó PASSO 2: Verificando ve√≠culos dispon√≠veis');

    // 2.1 Aguardar carregamento do contador de ve√≠culos
    cy.get('.vehicle-counter', { timeout: 10000 }).should('be.visible');

    // 2.2 Verificar se h√° ve√≠culos
    cy.get('body').then($body => {
      const hasVehicles =
        !$body.text().includes('0 ve√≠culos') && !$body.text().includes('Nenhum ve√≠culo');

      if (hasVehicles) {
        cy.log('‚úÖ Ve√≠culos encontrados, continuando com o fluxo');
      } else {
        cy.log('‚ö†Ô∏è Nenhum ve√≠culo encontrado, pulando passos seguintes');
        return; // Pular resto do teste se n√£o h√° ve√≠culos
      }
    });

    // ========================================================================================
    // PASSO 3: DEFINIR COLETA PARA VE√çCULOS COM DATA D+1
    // ========================================================================================
    cy.log(`üìÖ PASSO 3: Definindo coleta com data D+1 (${tomorrowDate})`);

    // 3.1 Aguardar carregamento da se√ß√£o de coletas
    cy.contains('Coleta de Ve√≠culos').should('be.visible');

    // 3.2 Verificar se h√° sugest√µes pendentes ou criar nova
    cy.get('body').then($body => {
      if ($body.text().includes('Nenhuma sugest√£o pendente')) {
        cy.log('üìù Nenhuma sugest√£o pendente, criando nova coleta via API');

        // Criar coleta diretamente via API usando o endpoint set-vehicles-collection
        cy.window().then(win => {
          const supabaseSessionKey = Object.keys(win.localStorage).find(key =>
            key.match(/^sb-.*-auth-token$/)
          );

          if (supabaseSessionKey) {
            const sessionValue = win.localStorage.getItem(supabaseSessionKey);
            if (sessionValue) {
              const sessionData = JSON.parse(sessionValue);
              const token = sessionData.access_token;

              // Buscar endere√ßo rec√©m-criado
              cy.request({
                method: 'GET',
                url: '/api/client/addresses',
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }).then(addressResponse => {
                const addresses = addressResponse.body;
                const newAddress = addresses.find(
                  (addr: { is_collect_point: boolean }) => addr.is_collect_point
                );

                if (newAddress) {
                  createdAddressId = newAddress.id;

                  // Definir coleta para todos os ve√≠culos
                  cy.request({
                    method: 'POST',
                    url: '/api/client/set-vehicles-collection',
                    headers: {
                      Authorization: `Bearer ${token}`,
                      'Content-Type': 'application/json',
                    },
                    body: {
                      method: 'collect_point',
                      addressId: createdAddressId,
                      estimated_arrival_date: tomorrowDate,
                      vehicleIds: [], // Todos os ve√≠culos
                    },
                  }).then(collectionResponse => {
                    expect(collectionResponse.status).to.eq(200);
                    expect(collectionResponse.body.success).to.be.true;
                    cy.log('‚úÖ Coleta definida via API com sucesso');
                  });
                }
              });
            }
          }
        });
      } else {
        cy.log('üìã Sugest√µes pendentes encontradas, interagindo via interface');

        // Interagir com sugest√µes existentes
        cy.get('.vehicle-item')
          .first()
          .within(() => {
            // Clicar em "Sugerir outra data"
            cy.contains('Sugerir outra data').click();
          });

        // Aguardar date picker aparecer
        cy.get('input[type="date"], [data-cy="date-picker"]').should('be.visible');

        // Definir data D+1
        cy.get('input[type="date"], [data-cy="date-picker"]').then($dateInput => {
          cy.wrap($dateInput).invoke('val', tomorrowDate).trigger('change');
        });

        // Enviar sugest√£o
        cy.contains('Enviar sugest√£o').click();

        // Aguardar resposta da API
        cy.wait('@rescheduleCollection').then(interception => {
          expect(interception.response?.statusCode).to.eq(200);
          expect(interception.response?.body.success).to.be.true;
        });

        // Verificar mensagem de sucesso
        cy.contains('Solicita√ß√£o de nova data enviada').should('be.visible');

        cy.log('‚úÖ Sugest√£o de data D+1 enviada com sucesso');
      }
    });

    // ========================================================================================
    // PASSO 4: VERIFICA√á√ïES FINAIS E VALIDA√á√ïES
    // ========================================================================================
    cy.log('üîç PASSO 4: Verifica√ß√µes finais');

    // 4.1 Verificar se ainda estamos no dashboard
    cy.url().should('include', '/dashboard');

    // 4.2 Verificar se n√£o h√° erros na tela
    cy.get('body').should('not.contain', 'Erro');
    cy.get('body').should('not.contain', 'Falha');

    // 4.3 Verificar se o bot√£o de logout ainda funciona (usu√°rio ainda logado)
    cy.get('button, a').contains(/sair/i).should('be.visible');

    // 4.4 Capturar screenshot final para documenta√ß√£o
    cy.screenshot('client-collection-flow-completed', { capture: 'fullPage' });

    cy.log('‚úÖ FLUXO COMPLETO DE COLETA CONCLU√çDO COM SUCESSO!');
    cy.log(`üìä Resumo: Login ‚Üí Ponto de Coleta ‚Üí Coleta D+1 (${tomorrowDate})`);
  });

  it('should handle edge cases and error scenarios', () => {
    // ========================================================================================
    // TESTE DE CEN√ÅRIOS DE ERRO E EDGE CASES
    // ========================================================================================
    cy.log('üß™ TESTANDO CEN√ÅRIOS DE ERRO');

    // Login
    cy.login('cliente@prolineauto.com.br', '123qwe');
    cy.url().should('include', '/dashboard');

    // Testar formul√°rio de ponto de coleta com dados inv√°lidos
    cy.contains('Adicionar Ponto de Coleta').click();

    // Tentar submeter sem CEP
    cy.get('#street').type('Rua Teste');
    cy.get('button[type="submit"]').click();

    // Verificar valida√ß√£o
    cy.get('.error-message, [data-cy="error"]').should('be.visible');

    // Fechar modal
    cy.contains('Cancelar').click();

    cy.log('‚úÖ Cen√°rios de erro testados com sucesso');
  });

  it('should validate date constraints and business rules', () => {
    // ========================================================================================
    // TESTE DE VALIDA√á√ÉO DE REGRAS DE NEG√ìCIO
    // ========================================================================================
    cy.log('üìã VALIDANDO REGRAS DE NEG√ìCIO');

    // Login
    cy.login('cliente@prolineauto.com.br', '123qwe');
    cy.url().should('include', '/dashboard');

    // Verificar se data m√≠nima √© hoje
    cy.contains('Coleta de Ve√≠culos').should('be.visible');

    // Verificar se h√° restri√ß√µes de data no date picker
    cy.get('input[type="date"], [data-cy="date-picker"]').then($input => {
      const minDate = $input.attr('min');
      if (minDate) {
        const today = new Date().toISOString().split('T')[0];
        expect(minDate).to.eq(today);
        cy.log('‚úÖ Restri√ß√£o de data m√≠nima validada');
      }
    });

    cy.log('‚úÖ Regras de neg√≥cio validadas com sucesso');
  });
});
